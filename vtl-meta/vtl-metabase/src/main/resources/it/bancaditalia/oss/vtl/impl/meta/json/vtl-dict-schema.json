{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://sdmx.org/vtl-dict-schema.json",
  "description": "VTL Dictionary JSON serialization schema",
  "version": "2.2.0",
  
  "$defs": {
    "vtl-id": {
      "type": "string",
      "pattern": "^[A-Za-z_][A-Za-z0-9_.]*$|^'.*'$|^[A-Za-z_][A-Za-z0-9_.]*:[A-Za-z_][A-Za-z0-9_.]*(\\([0-9]+(\\.[0-9]+)*(\\.[_+*~])?\\))?(:(\\.[A-Za-z0-9_])+)?$"
    },
    "identifiable": {
      "type": "object",
      "properties": {
        "name": { "$ref": "#/$defs/vtl-id" },
        "description": { "type": "string" }
      },
      "required": [ "name" ]
    },
    "has-role": {
      "type": "object",
      "properties": {
        "role": {
          "type": "string",
          "enum": [ "Identifier", "Measure", "Attribute", "Viral Attribute" ]
        }
      },
      "required": [ "role" ]
    }
  },
  
  "type": "object",
  "properties": {
    "schema-version": { "type": "string"},
    "data": {
      "type": "array",
      "items": {
        "allOf": [ { "$ref": "#/$defs/identifiable" } ],
        "properties": {
          "structure": { "$ref": "#/$defs/vtl-id" },
          "components": { 
            "type": "array",
            "items": {
              "allOf": [ { "$ref": "#/$defs/identifiable" } ],
              "properties": {
                "subset": { "$ref": "#/$defs/vtl-id" },
                "nullable": { "type": "boolean" }
              },
              "required": [ "subset" ]
            }
          },
          "subset": { "$ref": "#/$defs/vtl-id" },
          "source": { "type": "string" }
        },
        "oneOf": [
          { "required": [ "structure" ], "not": { "required": [ "subset" ] } },
          { "required": [ "subset" ], "not": { "anyOf": [ { "required": [ "structure" ] }, { "required": [ "components" ] } ] } }
        ]
      }
    },
    "structures": {
      "type": "array",
      "items": {
        "allOf": [ { "$ref": "#/$defs/identifiable" } ],
        "properties": {
          "components": {
            "type": "array",
            "items": {
              "allOf": [ { "$ref": "#/$defs/identifiable" }, { "$ref": "#/$defs/has-role" } ],
              "properties": {
                "nullable": { "type": "boolean" }
              }
            }
          }
        },
        "required": [ "components" ]
      }
    },
    "variables": {
      "type": "array",
      "items": {
        "allOf": [ { "$ref": "#/$defs/identifiable" } ],
        "properties": {
          "domain": { "$ref": "#/$defs/vtl-id" }
        },
        "required": [ "domain" ]
      }
    },
    "domains": {
      "type": "array",
      "items": {
        "allOf": [ { "$ref": "#/$defs/identifiable" } ],
        "unevaluatedProperties": false,
        "oneOf": [
          {
            "properties": {
              "externalRef": { "type": "string" }
            },
            "required": [ "externalRef" ]
          }, {
            "properties": {
              "parent": { "$ref": "#/$defs/vtl-id" }
            },
            "required": [ "parent" ],
            "oneOf": [ 
              {
                "properties": {
                  "enumerated": { 
			        "type": "array",
			        "uniqueItems": true,
			        "minItems": 1,
			        "items": {
			          "oneOf": [
			          	{ "type": "string" },
			          	{ "allOf": [ { "$ref": "#/$defs/identifiable" } ] }
			          ]
			        }
                  }
                },
                "required": [ "enumerated" ]
              },
              {
                "properties": {
                  "described": { "type": "string" },
                  "mask": { "type": "string" }
                },
                "required": [ "described" ]
              }
            ]
          }
        ]
      }
    }
  },
  "required": [ "schema-version" ]
}